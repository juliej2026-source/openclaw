# OpenClaw Hive Mind Portal â€” Apache Virtual Host
# Deploy: cp httpd.conf /etc/apache2/sites-available/hivemind.conf
# Required modules: proxy, proxy_http, proxy_wstunnel, rewrite, headers

<VirtualHost *:80>
    ServerName 10.1.8.158
    DocumentRoot /opt/openclaw-portal/htdocs

    <Directory /opt/openclaw-portal/htdocs>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        <FilesMatch "\.(css|js|svg|png)$">
            Header set Cache-Control "public, max-age=3600"
        </FilesMatch>
        <FilesMatch "\.html$">
            Header set Cache-Control "no-cache"
        </FilesMatch>
    </Directory>

    # ---- Reverse proxy to Node.js hive-mind backend (port 3001) ----
    ProxyPreserveHost On
    ProxyTimeout 30

    ProxyPass        /api/     http://127.0.0.1:3001/api/
    ProxyPassReverse /api/     http://127.0.0.1:3001/api/
    ProxyPass        /metrics  http://127.0.0.1:3001/metrics
    ProxyPassReverse /metrics  http://127.0.0.1:3001/metrics
    ProxyPass        /monitor  http://127.0.0.1:3001/monitor
    ProxyPassReverse /monitor  http://127.0.0.1:3001/monitor
    ProxyPass        /health   http://127.0.0.1:3001/health
    ProxyPassReverse /health   http://127.0.0.1:3001/health
    # ---- Grafana sub-path proxy (port 3030, when Docker stack runs) ----
    # WebSocket upgrade for Grafana Live (must come before HTTP proxy)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/grafana/(.*) ws://127.0.0.1:3030/grafana/$1 [P,L]

    ProxyPass        /grafana/ http://127.0.0.1:3030/grafana/
    ProxyPassReverse /grafana/ http://127.0.0.1:3030/grafana/

    # ---- Inject API key server-side (browser never sees the key) ----
    <Location "/api/">
        RequestHeader set X-API-Key "openclaw-network-2026-kelvin"
        Header always set Access-Control-Allow-Origin "http://10.1.8.158"
        Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type"
    </Location>

    # ---- SPA fallback: non-file requests serve index.html ----
    RewriteEngine On
    RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI} !-f
    RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI} !-d
    RewriteCond %{REQUEST_URI} !^/(api|metrics|monitor|health|grafana)(/|$)
    RewriteRule ^ /index.html [L]

    # ---- Security headers ----
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # ---- Relax CSP for proxied backend pages (monitor uses inline script + Google Fonts) ----
    <Location "/monitor">
        Header always unset Content-Security-Policy
    </Location>

    # ---- Relax CSP for Grafana (it manages its own security headers) ----
    <Location "/grafana/">
        Header always unset Content-Security-Policy
        Header always unset X-Frame-Options
    </Location>

    ErrorLog  ${APACHE_LOG_DIR}/hivemind-error.log
    CustomLog ${APACHE_LOG_DIR}/hivemind-access.log combined
</VirtualHost>
